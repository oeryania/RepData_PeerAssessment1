---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---


## Loading & preprocessing data

Read data
```{r message = F}
library(dplyr)
unzip("activity.zip", exdir = getwd())
act <- "activity.csv" %>% read.csv()
str(act)
```

Check for missing values
```{r}
colSums(is.na(act))
```

Preprocess data
```{r}
act <- mutate(act,
        date = as.Date(date),
        interval = factor(interval),
        weekday = weekdays(date),
        is_weekend = weekdays(date) %in% c("Saturday", "Sunday")
    )
intervals <- levels(act$interval)
str(act)
```

## Histogram of daily steps

```{r}
# function to plot histogram of steps (supports multiple plots)
hist_steps <- function(act_df) {
    # calculate number of steps per day
    res <- summarize(act_df, daily_steps = sum(steps, na.rm = T), .by = date)
    
    # plot histogram
    par(mar = c(5.1, 4.1, 1.1, 2.1))
    
    hist(res$daily_steps, xlab = "Daily Steps", main = "")
    
    # add mean line
    mean_value <- mean(res$daily_steps)
    mean_label <- paste("   Mean","=  ", round(mean_value))
    mean_color <- "blue"
    abline(v = mean_value, lty = 2, col = mean_color)
    
    # add median line
    median_value <- median(res$daily_steps)
    median_label <- paste("Median","=", round(median_value))
    median_color <- "red"
    abline(v = median_value, lty = 2, col = median_color)
    
    # add legend
    legend("topright", legend = c(mean_label, median_label),
           lty = 2, cex = 0.7, col = c(mean_color, median_color))
}

hist_steps(act)
```

## Average daily activity pattern

```{r}
to_time <- function(x) sub("(\\d\\d)$", ":\\1", x)
x_increment <- function(hours) seq(from = 1, to = length(intervals)+1, by = 60*hours/5)

plot_daily_activity <- function(plots) {
    number_of_plots <- length(plots)
    par(mfrow = c(number_of_plots,1), mar = c(1.5, 2.5, 2, 2), mgp = c(1.5, 0.5, 0))
    for (i in 1:number_of_plots) {
        res <- summarize(plots[[i]], avg_steps = mean(steps, na.rm = T), .by = interval)
        plot(avg_steps ~ interval, res,
             xlab = "",
             ylab = "Average Steps",
             main = names(plots)[i],
             cex.lab = 0.7, cex.axis = 0.7, cex.main = 0.7, xaxt = "n")
        axis(1, at = x_increment(1), labels = to_time(intervals[x_increment(1)]), cex.axis = 0.7)
        points(avg_steps ~ interval, res, type = "l")
        points(avg_steps ~ interval, res, type = "p", pch = 1, cex = .5, col = "coral3")
        max_point <- filter(res, avg_steps == max(avg_steps))
        text(max_point$interval, max_point$avg_steps,
             labels = paste(round(max_point$avg_steps), "steps at", to_time(max_point$interval)),
             pos = 4, cex = 0.7)
    }
}

plot_daily_activity(list("Daily Activity" = act))

```

## 6. Impute missing data

Visualize steps data across intervals and dates

```{r}
#Returns red for NA, white for 0, and lightgray to black for >0
number_of_colors <- max(na.omit(act$steps)) + 1
gradient <- colorRampPalette(c("lightgray", "black"))(number_of_colors)
colorscale <- function(x) ifelse(is.na(x), "red", ifelse(x == 0, "white", gradient[x + 1]))

par(mar = c(2,2,2,2), mgp = c(0.2, 0.5, 0))

plot(date ~ interval, act,
     xlab = "Time", ylab = "",
     col = colorscale(steps),
     pch = 15, cex = .2, xaxt = "n", cex.axis = 0.7, cex.lab = 0.7
     )
```

The missing steps data seems to be located in 8 completely missing days.

```{r}
dates_status <- act %>%
    summarize(missing = is.na(all(steps)), .by = date) %>%
    mutate(weekday = weekdays(date))
table(select(dates_status, missing, weekday))
missing_dates <- filter(dates_status, missing == T)
```
Every missing weekday has more than double non-missing weekdays.  
We will use the average of the non-missing days to impute the missing days.

Imputes data based on summary function applied to weekday
```{r}
impute <- function(imp_fun, act_df) {
    act_imp <- data.frame(act_df)
    summ <- summarize(act_imp, steps = imp_fun(steps, na.rm = T), .by = c(weekday, interval))
    summ$steps <- round(summ$steps)
    for (i in 1:nrow(missing_dates))
        act_imp$steps[act_imp$date == missing_dates$date[i]] = 
            filter(summ, weekday == missing_dates$weekday[i])$steps
    act_imp
}
```

Revisualize to confirm no missing data.

```{r}
plot_multiple <- function(plots) {
    number_of_plots <- length(plots)
    par(mfrow = c(1,number_of_plots), mar = c(0, 0, 1, 0))
    for (i in 1:number_of_plots) {
    plot(date ~ interval, plots[[i]],
         xlab = "", ylab = "", main = names(plots)[i], cex.main = 0.7,
         col = colorscale(steps),
         pch = 15, cex = .2, xaxt = "n", yaxt = "n"
         )
    }
}
plot_multiple(list("data with missing days" = act,
                   "impute with weekday MEAN" = impute(mean, act),
                   "impute with weekday MEDIAN" = impute(median, act)
              ))
```

Unlike the `mean` which seems to smear the data across the intervals,  
the `median` generates more natural-looking results, indistinguishable from real data.  

```{r}
act_imp <- impute(median, act)
```

## 7. Histogram of the total number of steps taken each day after missing values are imputed

```{r}
hist_steps(act)
hist_steps(act_imp)
```

The histogram of the imputed data (`act_imp`) looks similar to the original.  
However the `mean` seems to have shifted slightly to the right.

## 8. Are there differences in activity patterns between weekdays and weekends?

```{r}
plot_daily_activity(list(
    "WEEKEND Daily Activity" = filter(act_imp, is_weekend),
    "WEEKDAY Daily Activity" = filter(act_imp, !is_weekend)
    ))

```

While weekdays have the highest average steps per interval,  
weekends activity is more distributed throughout the day.